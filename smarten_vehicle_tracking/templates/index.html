<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1" name="viewport" />
    <title>Fleet Report</title>
    <link
      crossorigin="anonymous"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
      rel="stylesheet"
    />
    <link
      crossorigin=""
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"
    />
    <style>
      body,
      html {
        margin: 0;
        padding: 0;
      }

      #map {
        width: 100%;
        height: 100vh;
        background-color: #f0f0f0;
        position: relative;
      }

      #side-box {
        background: #714b67;
        width: 350px;
        height: max-content;
        position: absolute;
        top: 10px;
        left: 10px;
        bottom: 10px;
        padding: 10px;
        border-radius: 10px;
        z-index: 999;
      }

      #right-box {
        background: #714b67;
        width: 200px;
        height: max-content;
        position: absolute;
        top: 10px;
        right: 10px;
        bottom: 10px;
        padding: 10px;
        border-radius: 10px;
        z-index: 999;
      }

      .device-box {
        width: 100%;
        min-height: 30px;
        max-height: max-content;
        color: white;
        margin-top: 8px;
        margin-bottom: 8px;
        padding-top: 10px;
        padding-bottom: 10px;
      }

      .report-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
        color: white;
        padding-top: 15px;
        padding-bottom: 15px;
      }

      .device-icon {
        display: flex;
        justify-content: center;
        align-items: center;
        border-radius: 50%;
        background: #545151;
        height: 100%;
        min-height: 30px;
      }

      .device-box:hover {
        background: #017e84;
      }

      .box-hover {
        background: #017e84;
      }

      .report-row:hover {
        background: #017e84;
        color: white;
      }

      #result-box {
        height: auto;
        max-height: 80vh;
        overflow-x: hidden;
        overflow-y: scroll;
      }

      #report-result-box {
        height: auto;
        max-height: 80vh;
        overflow-x: hidden;
        overflow-y: scroll;
      }

      #result-box {
        -ms-overflow-style: none; /* Internet Explorer 10+ */
        scrollbar-width: none; /* Firefox */
      }

      #report-result-box {
        -ms-overflow-style: none; /* Internet Explorer 10+ */
        scrollbar-width: none; /* Firefox */
      }

      #result-box::-webkit-scrollbar {
        display: none; /* Safari and Chrome */
      }

      #report-result-box::-webkit-scrollbar {
        display: none; /* Safari and Chrome */
      }

      .leaflet-div-icon {
        background: none !important;
        border: none !important;
      }

      #speed-control {
        position: absolute;
        background: #d7d6d6;
        width: 250px;
        height: 50px;
        top: 10px;
        bottom: 10px;
        right: 220px;
        padding: 10px;
        border-radius: 10px;
        z-index: 999;
        display: flex;
        justify-content: space-between;
      }

      .center-item {
        display: flex;
        align-items: center;
      }

      .select2-container--default .select2-selection--single {
        height: 46px !important;
        padding: 10px 16px;
        font-size: 18px;
        line-height: 1.33;
        border-radius: 6px;
      }

      .select2-container--default
        .select2-selection--single
        .select2-selection__arrow
        b {
        top: 85% !important;
      }

      .select2-container--default
        .select2-selection--single
        .select2-selection__rendered {
        line-height: 26px !important;
      }

      .select2-container--default .select2-selection--single {
        border: 1px solid #ccc !important;
        box-shadow: 0px 1px 1px rgba(0, 0, 0, 0.075) inset;
        transition: border-color 0.15s ease-in-out 0s,
          box-shadow 0.15s ease-in-out 0s;
      }

      .select2-selection__arrow {
        display: none;
      }

      .select2-search--dropdown .select2-search__field {
        width: 466px;
        position: relative;
        left: 7px;
        height: 43px;
      }

      .select2-dropdown {
        border: none;
      }

      .btn-center {
        display: flex;
        justify-content: center;
        margin-top: 10px;
        border: 1px solid #0aa2c0;
      }

      .btn-center:hover {
        border: 1px solid #3391a2;
        background: #0aa2c0;
        color: white;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <div id="side-box">
      <div class="w-100 p-2 d-flex justify-content-between">
        <a
          href="/web"
          class="btn ms-2"
          style="background: #8f8f8f; color: white"
        >
          <i class="bi bi-skip-backward me-2"></i>
          Back
        </a>
        <button
          class="btn"
          style="background: #017e84; color: white"
          data-bs-toggle="modal"
          data-bs-target="#filterModel"
        >
          <i class="bi bi-funnel"></i>
          Filter
        </button>
      </div>
      <div class="w-100 mb-3">
        <input
          autocomplete="off"
          class="form-control"
          id="search-device"
          placeholder="Search Device"
          type="search"
          onkeyup="searchDevice(this.value)"
        />
      </div>
      <div class="row" id="result-box"></div>
      <div class="w-100 d-flex justify-content-center">
        <a class="btn" style="background: #017e84; color: white" href="/maps">
          <i class="bi bi-arrow-clockwise me-2"></i>
          View All Vehicle Last Location
        </a>
      </div>
    </div>

    <div id="right-box" style="background: #714b67 !important">
      <div class="row">
        <h5 style="color: white" class="text-center fw-bolder">Report</h5>
        <hr />
      </div>
      <div class="row" id="report-result-box"></div>
    </div>

    <div id="speed-control">
      <div
        class="btn center-item"
        style="background: #017e84; color: white"
        onclick="changeReplaySpeed('minus')"
      >
        <i class="bi bi-dash"></i>
      </div>
      <div class="form-control center-item" id="speed_display">0.5 Second</div>
      <div
        class="btn center-item"
        style="background: #714b67; color: white"
        onclick="changeReplaySpeed('plus')"
      >
        <i class="bi bi-plus"></i>
      </div>
    </div>

    <div
      class="modal fade"
      id="filterModel"
      tabindex="-1"
      aria-labelledby="filterModelLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="filterModelLabel">
              Vehicle Report
            </h1>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div class="form-group mt-3 mb-3 row">
              <label for="form-devices" class="form-label">
                Select Vehicle
              </label>
              <select
                name="device"
                id="form-devices"
                class="form-control"
                style="width: 100%"
                autocomplete="off"
              ></select>
            </div>
            <div class="form-group mt-3 row">
              <div class="col-lg-6 col-md-6 col-sm-12">
                <label for="form-from-datepicker" class="form-label">
                  From Date
                </label>
                <input
                  type="date"
                  class="form-control"
                  id="form-from-datepicker"
                />
              </div>
              <div class="col-lg-6 col-md-6 col-sm-12">
                <label for="form-to-datepicker" class="form-label">
                  To Date
                </label>
                <input
                  type="date"
                  class="form-control"
                  id="form-to-datepicker"
                />
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn"
              style="background: #8f8f8f; color: white"
              data-bs-dismiss="modal"
            >
              Close
            </button>
            <button
              type="button"
              class="btn"
              style="background: #017e84; color: white"
              onclick="getVehicleReport()"
            >
              Get Report
            </button>
          </div>
        </div>
      </div>
    </div>

    <div
      class="modal fade"
      id="reportModel"
      data-bs-backdrop="static"
      data-bs-keyboard="false"
      tabindex="-1"
      aria-labelledby="reportModelLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content"></div>
      </div>
    </div>
    <script
      crossorigin="anonymous"
      integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
    ></script>

    <script
      crossorigin="anonymous"
      integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="
      src="https://code.jquery.com/jquery-3.7.1.min.js"
    ></script>
    <script
      crossorigin=""
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    ></script>

    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <script>
      let speed = 0.5;
      let map;
      let traccar_url;
      let traccar_key;
      let devices = [];
      let reports = [];
      const device_result_box = $("#result-box");
      const right_box = $("#right-box");
      const speed_control_box = $(" #speed-control");
      const url = window.location.href;

      const truckIcon =
        '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" id="truck"><path d="m3 28.3 13.1-7.5 27.9 14-14 7z" opacity=".3"></path><path fill="#2D3134" d="M5.3 25v3.8l2.5-1.3v-3.7z"></path><path d="M5.3 25v3.8l2.5-1.3v-3.7z" opacity=".39"></path><path fill="#2D3134" d="M26.2 32.9c-.7-.4-1.4-.4-1.9-.2l-1.4.7c-.6.2-.9.8-.9 1.6 0 1.5 1.3 3.4 2.8 4.2.8.4 1.5.4 2 .2 0 0 1.4-.7 1.5-.8.5-.3.7-.8.7-1.5 0-1.6-1.3-3.5-2.8-4.2z"></path><path d="M26.8 39.3c.2-.1 1.4-.7 1.5-.7.5-.3.7-.8.7-1.5 0-.6-.2-1.3-.5-1.9l-1.4.7c.3.6.5 1.3.5 1.9 0 .7-.3 1.3-.8 1.5z" opacity=".39"></path><path fill="#999" d="M26.9 37.4c0 1.2-.9 1.6-2.1 1-1.2-.6-2.1-2-2.1-3.2s.9-1.6 2.1-1c1.2.6 2.1 2 2.1 3.2z"></path><path d="M25 38.4c-1.2-.6-2.1-2-2.1-3.2 0-.6.2-1 .6-1.2-.5.1-.8.6-.8 1.2 0 1.2.9 2.6 2.1 3.2.6.3 1.1.3 1.5.1-.4.2-.8.1-1.3-.1z" opacity=".15"></path><path fill="#2D3134" d="M25.9 36.7c0 .5-.4.7-.9.4s-.9-.8-.9-1.3.4-.7.9-.4.9.8.9 1.3z"></path><path d="M25.9 36.7c0 .5-.4.7-.9.4s-.9-.8-.9-1.3.4-.7.9-.4.9.8.9 1.3z" opacity=".39"></path><path fill="#2D3134" d="M25.7 36.8c0 .5-.4.7-.9.4-.5-.2-.9-.8-.9-1.3s.4-.7.9-.4c.5.2.9.8.9 1.3z"></path><path d="M27.6 37.8c0 1.5-1.3 2.2-2.8 1.4-1.5-.8-2.8-2.7-2.8-4.2s1.3-2.2 2.8-1.4c1.5.7 2.8 2.6 2.8 4.2z" opacity=".06"></path><path fill="#2D3134" d="M9.7 24.6c-.7-.4-1.4-.4-1.9-.2l-1.4.7c-.5.2-.9.8-.9 1.6 0 1.5 1.3 3.4 2.8 4.2.8.4 1.5.4 2 .2 0 0 1.4-.7 1.5-.8.5-.3.7-.8.7-1.5 0-1.5-1.3-3.4-2.8-4.2z"></path><path d="M10.3 31.1c.2-.1 1.4-.7 1.5-.7.5-.3.7-.8.7-1.5 0-.6-.2-1.3-.5-1.9l-1.4.7c.3.6.5 1.3.5 1.9 0 .7-.3 1.2-.8 1.5z" opacity=".39"></path><path fill="#999" d="M10.4 29.2c0 1.2-.9 1.6-2.1 1s-2.1-2-2.1-3.2.9-1.6 2.1-1 2.1 2 2.1 3.2z"></path><path d="M8.5 30.1c-1.2-.6-2.1-2-2.1-3.2 0-.6.2-1 .6-1.2-.5.1-.8.6-.8 1.2 0 1.2.9 2.6 2.1 3.2.6.3 1.1.3 1.5.1-.4.2-.8.2-1.3-.1z" opacity=".15"></path><path fill="#2D3134" d="M9.4 28.5c0 .5-.4.7-.9.4-.5-.2-.9-.8-.9-1.3s.4-.7.9-.4c.5.2.9.8.9 1.3z"></path><path d="M9.4 28.5c0 .5-.4.7-.9.4-.5-.2-.9-.8-.9-1.3s.4-.7.9-.4c.5.2.9.8.9 1.3z" opacity=".39"></path><path fill="#2D3134" d="M9.2 28.5c0 .5-.4.7-.9.4s-.9-.8-.9-1.3.4-.7.9-.4.9.9.9 1.3z"></path><path d="M11.1 29.5c0 1.5-1.3 2.2-2.8 1.4-1.5-.8-2.8-2.7-2.8-4.2s1.3-2.2 2.8-1.4c1.5.8 2.8 2.7 2.8 4.2z" opacity=".06"></path><path fill="#F90" d="M17 1 3 8v15.3l18 9L35 25V10z"></path><path fill="#2D3134" d="M3 22v2l18 9v-2zM35 24v2l-14 7v-2z"></path><path d="M3 8v16l18 9V17z" opacity=".06"></path><path d="M35 10v16l-14 7V17z" opacity=".39"></path><path fill="#E5E5E5" d="m42 18-6-3-14 7v11.3c0 .3.4.5.7.3 1.2-1 3.3-.3 4.8 1.5.9 1.1 1.3 2.3 1.3 3.3l1.2.6 14-7v-8l-2-6z"></path><path fill="#39C" d="m30.4 30.5-1.7-5c-.1-.2 0-.3.2-.4l12.5-6.2c.2-.1.4 0 .5.2l1.6 4.7c.1.2 0 .3-.2.4l-12.4 6.5c-.2.1-.5 0-.5-.2z"></path><path d="m32.7 23.2 8.6-4.3c.2-.1.4 0 .5.2l1.5 4.4-10.6-.3z" opacity=".15"></path><path fill="#2D3134" d="m43.4 23.8-.1-.3c0 .2 0 .3-.2.4l-12.4 6.5c-.2.1-.4 0-.5-.2l.1.3c.1.2.3.3.5.2l12.4-6.5c.2-.1.3-.2.2-.4z"></path><path fill="#FFF" d="m33.5 30 7-3.5v5.8l-7 3.5z"></path><path fill="#2D3134" d="m34 35 6-3v-4.7l-6 3z"></path><path fill="#2D3134" d="M44 32v-2l-14 7v2zM28 38l2 1v-2l-2-1z"></path><path fill="#FFF" d="M34 35v1l6-3v-1z"></path><path fill="#39C" d="m27.5 25.3-3.8-1.9c-.1-.1-.3 0-.3.2v3c0 .2.1.4.3.4l1.3.7c.1.1.2.1.3.2l1.3 1.6h.1l2.2 1.1c.1.1.3-.1.2-.2l-1.7-5c.2 0 .2-.1.1-.1z"></path><path d="m29.3 30.3-2-1h-.1l-1.3-1.6c-.1-.1-.2-.2-.3-.2l-1.3-.7c-.2-.1-.3-.2-.3-.4v-2.9l-.2-.1c-.1-.1-.3 0-.3.2v3c0 .2.1.4.3.4l1.3.7c.1.1.2.1.3.2l1.3 1.6h.1l2.2 1.1c.2.1.3 0 .3-.3z" opacity=".15"></path><path fill="#FC0" d="M30 35v2l-.5-.2v-2z"></path><path fill="#E5E5E5" d="M34 31v.3l6-3V28zM34 32v.3l6-3V29zM34 33v.3l6-3V30zM34 34v.3l6-3V31z"></path><path fill="#2D3134" d="M23.5 28.3v.5l1 .5v-.5z" opacity=".5"></path><path fill="#FFF" d="m24.5 29.5-1-.5v-.2l1 .5z" opacity=".5"></path><path fill="#2D3134" d="M37.5 23.9c-.1-.1-.2-.1-.3 0l-3.8 4.3c-.1.1-.1.2 0 .3s.2.1.3 0l1-1.2v1h.3V27l2.5-2.9c.1 0 .1-.2 0-.2zM41.1 21.9c-.1-.1-.2-.1-.3 0L37 26.2c-.1.1-.1.2 0 .3.1.1.2.1.3 0l.9-1v1.1h.3v-1.4l2.6-3c.1-.1.1-.2 0-.3z"></path><path fill="#FFF" d="m42 31 2-1v-2l-1 .5c-.6.3-1 .9-1 1.6v.9z"></path><ellipse cx="42.7" cy="29.5" fill="#2D3134" opacity=".3" rx=".8" ry=".5" transform="rotate(129.144 42.715 29.544)"></ellipse><ellipse cx="43.2" cy="29.5" fill="#2D3134" opacity=".3" rx=".8" ry=".5" transform="rotate(129.144 43.216 29.544)"></ellipse><path fill="#FFF" d="m42 31 2-1v-2z" opacity=".3"></path><path fill="#FFF" d="m30 37 2-1v-.9c0-.5-.5-.8-1-.6l-1 .5v2z"></path><ellipse cx="31.2" cy="35.5" fill="#2D3134" opacity=".3" rx=".8" ry=".5" transform="rotate(129.144 31.216 35.544)"></ellipse><ellipse cx="30.7" cy="35.5" fill="#2D3134" opacity=".3" rx=".8" ry=".5" transform="rotate(129.144 30.716 35.544)"></ellipse><path fill="#FFF" d="m30 37 2-1-2-1z" opacity=".3"></path><path d="m28 25-6-3v11.3c0 .3.4.5.7.3 1.2-1 3.3-.3 4.8 1.5.3.3.5.6.6 1L28 36v2l2 1v-8l-2-6z" opacity=".06"></path><path d="m42 18-14 7 2 6v8l14-7v-8z" opacity=".39"></path></svg>';
      const dotIcon = `<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M12 9.5C13.3807 9.5 14.5 10.6193 14.5 12C14.5 13.3807 13.3807 14.5 12 14.5C10.6193 14.5 9.5 13.3807 9.5 12C9.5 10.6193 10.6193 9.5 12 9.5Z" fill="#000000"/>
</svg>`;
      const leafletIcon = L.divIcon({
        html: truckIcon,
        iconSize: [50, 50],
      });
      const dotMapIcon = L.divIcon({
        html: dotIcon,
        iconSize: [70, 70],
      });

      $(function () {
        right_box.hide();
        speed_control_box.hide();
        // initial map
        map = L.map("map").setView([27.7172, 85.324], 13);
        L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
          maxZoom: 19,
          attribution:
            '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
          name: "map",
        }).addTo(map);
        L.layerGroup().addTo(map);

        // remove zoom control from left size and add to right size
        map.zoomControl.remove();
        L.control
          .zoom({
            position: "topright",
          })
          .addTo(map);

        // fetch configs from db
        getConfig();

        // get device list from server
        fetchDeviceFromServer();

        if (url.indexOf("?") !== -1)
          // get parameters from url
          populatePreselectedReport();
        // populate last positions
        else fetchLatestPosition();

        // filter form
        $("#form-devices").select2({
          dropdownParent: $("#filterModel"),
        });

        let oneMonthAgo = new Date();
        oneMonthAgo.setMonth(oneMonthAgo.getMonth() - 1);

        $("#form-from-datepicker").flatpickr({
          enableTime: true,
          dateFormat: "Y-m-d H:i",
          maxDate: "today",
          minDate: oneMonthAgo,
          defaultHour: 0,
          defaultMinute: 0,
          onChange: function (selectedDates, dateStr, instance) {
            $("#form-to-datepicker").flatpickr({
              enableTime: true,
              dateFormat: "Y-m-d H:i",
              maxDate: "today",
              minDate: new Date(selectedDates),
              defaultHour: 23,
              defaultMinute: 55,
            });
          },
        });
        $("#form-to-datepicker").flatpickr({
          enableTime: true,
          dateFormat: "Y-m-d H:i",
          maxDate: "today",
          minDate: oneMonthAgo,
          defaultHour: 23,
          defaultMinute: 55,
        });

        $("#side-box").on("click", function () {
          right_box.hide();
          speed_control_box.hide();
        });
      });

      function populatePreselectedReport() {
        map.eachLayer((layer) => {
          if (layer.options.name !== "map") map.removeLayer(layer);
        });

        if (url.indexOf("?") !== -1) {
          const queryStringParts = url.split("?")[1];
          const reportId = queryStringParts.split("=")[1];
          const finalUrl = `/api/get-vehicle-report-by-id?reportId=${reportId}`;
          fetch(finalUrl)
            .then((response) => {
              if (!response.ok) {
                throw new Error("Network response was not ok");
              }
              return response.json();
            })
            .then((data) => {
              if (!data.status) throw new Error(data.message);

              map.eachLayer((layer) => {
                if (layer.options.name !== "map") map.removeLayer(layer);
              });
              report = data.data;
              const positions = report.positions;

              const marker1 = L.marker(
                [report.start_address.lat, report.start_address.lon],
                {}
              ).addTo(map);
              marker1.bindPopup(`Date : ${report.date}<br/>
                        PIN: Start Location<br/>`);

              const marker2 = L.marker(
                [report.end_address.lat, report.end_address.lon],
                {
                  icon: leafletIcon,
                }
              ).addTo(map);
              marker2
                .bindPopup(
                  `<b>Date : ${report.date}</b>
                        <br/>Speed: ${report.average_speed}
                        <br/>Distance: ${report.distance}
                        <br/>Pin: End Location<br/>
                        <a class="btn btn-link btn-center" href="/map/report/${report.vehicle}">View</a>
                    `
                )
                .openPopup();

              drawLineInMap(positions);

              highlightDevice(report.device_id);

              positions.map((position, key) => {
                if (key % 2 === 0)
                  L.marker([position.lat, position.lon], {
                    icon: dotMapIcon,
                  })
                    .addTo(map)
                    .bindPopup(
                      `Speed: ${Number(
                        position.speed.toFixed(2)
                      )} Km/h</br>Time : ${position.time}</br>`
                    );
              });
            })
            .catch((error) => {
              console.error(
                "There was a problem with the fetch operation:",
                error
              );
            });
        }
      }

      function getConfig() {
        fetch("/api/get-config-parameters")
          .then((response) => {
            if (!response.ok) {
              throw new Error("Network response was not ok");
            }
            return response.json();
          })
          .then((data) => {
            if (!data.status) throw new Error(data.message);
            const response = data.data;
            traccar_key = response.token;
            traccar_url = response.url;
          })
          .catch((error) => {
            console.error(
              "There was a problem with the fetch operation:",
              error
            );
          });
      }

      function fetchDeviceFromServer() {
        fetch("api/get-gps-devices")
          .then((response) => {
            if (!response.ok) {
              throw new Error("Network response was not ok");
            }
            return response.json();
          })
          .then((data) => {
            if (!data.status) throw new Error(data.message);

            devices = data.data;

            populateDevice(devices);
          })
          .catch((error) => {
            console.error(
              "There was a problem with the fetch operation:",
              error
            );
          });
      }

      function populateDevice(devices_list) {
        device_result_box.empty();
        $("#form-devices").empty();
        $("#form-devices").append(
          '<option value="" selected disabled>Select Vehicle</option>'
        );
        devices_list.map((device) => {
          device_result_box.append(`<div class="row device-box"
                id="device-${device.id}"
                onclick="getDeviceLocations('${device.id}')">
                <div class="col-2 ms-2">
                    <i class="bi bi-geo-alt-fill device-icon"></i>
                </div>
                <div class="col-9 ms-3" style="align-content: center">
                    <div class="row" >
                       ${device.vehicle}
                    </div>
                </div>
            </div><hr style="color: white">`);
          $("#form-devices").append(new Option(device.vehicle, device.id));
        });
      }

      function searchDevice(q) {
        const filtered_devices = devices.filter((device) =>
          device.vehicle.toLowerCase().includes(q.toLowerCase())
        );
        populateDevice(filtered_devices);
      }

      function fetchLatestPosition() {
        fetch("/api/get-latest-location")
          .then((response) => {
            if (!response.ok) {
              throw new Error("Network response was not ok");
            }
            console.log(response);

            return response.json();
          })
          .then((data) => {
            console.log(data);

            if (!data.status) throw new Error(data.message);

            const positions = data.data;
            console.log(positions);

            positions.map((position) => {
              console.log(position);

              const marker = L.marker([position.lat, position.lon], {
                name: "latest_markers",
                icon: leafletIcon,
              }).addTo(map);
              marker
                .bindPopup(
                  `Vehicle : ${position.vehicle.name}</b>Speed: ${position.speed}<br/>
                        Distance: ${position.report.distance}</br>
                       <a class="btn btn-link btn-center" href="/map/report/${position.vehicle.id}">View</a>`
                )
                .openPopup();
            });
          })
          .catch((error) => {
            console.error(
              "There was a problem with the fetch operation:",
              error
            );
          });
      }

      function getDeviceLocations(deviceId) {
        fetch(`/api/get-device-positions?deviceId=${deviceId}`)
          .then((response) => {
            if (!response.ok) {
              throw new Error("Network response was not ok");
            }
            return response.json();
          })
          .then((data) => {
            if (!data.status) throw new Error(data.message);

            map.eachLayer((layer) => {
              if (layer.options.name !== "map") map.removeLayer(layer);
            });
            highlightDevice(deviceId);

            const report = data.data.report;
            const marker1 = L.marker(
              [report.location.end.lat, report.location.end.lon],
              {
                icon: leafletIcon,
              }
            ).addTo(map);
            marker1
              .bindPopup(
                `Distance:${report.distance} <br/>
                       Speed: ${report.data.average}<br/>
                        Operation: ${report.data.duration}<br/>
                        Pin: Latest Location<br/>
                        <a class="btn btn-link btn-center" href="/map/report/${data.data.vehicle.id}">View</a>`
              )
              .openPopup();

            const marker2 = L.marker(
              [report.location.start.lat, report.location.start.lon],
              {}
            ).addTo(map);
            marker2.bindPopup("Pin: Start Location");

            drawLineInMap(data.data.positions);
          })
          .catch((error) => {
            console.error(
              "There was a problem with the fetch operation:",
              error
            );
          });
      }

      function drawLineInMap(positions, color = "red") {
        if (positions.length > 0) {
          let positions_array = [];
          positions.map((position) => {
            positions_array.push([position.lat, position.lon]);
          });

          const polyline = L.polyline(positions_array, {
            color: color,
            name: "path",
            weight: 5,
          }).addTo(map);

          map.fitBounds(polyline.getBounds());
        }
      }

      function removeMapLayer(layerName) {
        map.eachLayer((layer) => {
          if (layer.options.name === layerName) map.removeLayer(layer);
        });
      }

      function getVehicleReport() {
        map.eachLayer((layer) => {
          if (layer.options.name !== "map") map.removeLayer(layer);
        });
        const deviceId = $("#form-devices").val();
        const from_date = $("#form-from-datepicker").val();
        const to_date = $("#form-to-datepicker").val();

        if (deviceId == null || from_date == "" || to_date == "")
          alert("Please Select Data  in form");

        fetch(
          `/api/get-vehicle-reports?deviceId=${deviceId}&from_date=${from_date}&to_date=${to_date}`
        )
          .then((response) => {
            if (!response.ok) {
              throw new Error("Network response was not ok");
            }
            return response.json();
          })
          .then((data) => {
            if (!data.status) throw new Error(data.message);

            reports = data.data;
            const total_reports = reports.length;
            highlightDevice(deviceId);
            if (total_reports > 0) {
              $("#filterModel").modal("hide");
              right_box.show();
              $("#report-result-box").empty();

              const colors = generateUniqueColors(total_reports);
              let color_count = 0;
              reports.map((report) => {
                $("#report-result-box").append(`<div class="report-row">
                                <div onclick="viewReport('${report.id}')">${report.date}</div>
                                <div class="d-flex justify-content-end">
                                    <button class="btn btn-success btn-sm" onclick="replayVehicleTrip('${report.id}')"><i class="bi bi-play"></i></button>
                                    <button class="btn btn-primary btn-sm ms-1" onclick="viewReport('${report.id}')"><i class="bi bi-eye"></i></button>
                                </div>
                            </div><hr style="color: white">`);

                const positions = report.positions;

                const marker1 = L.marker(
                  [report.start_address.lat, report.start_address.lon],
                  {
                    name: "latest_markers",
                    icon: leafletIcon,
                  }
                ).addTo(map);
                marker1.bindPopup(`Date : ${report.date}</b>Driver: ${report.driver.name}<br/>Location: Start From<br/>
                        <a class="btn btn-link btn-center" href="/map/report/${report.vehicle}">View</a>`);

                const marker2 = L.marker(
                  [report.end_address.lat, report.end_address.lon],
                  {
                    name: "latest_markers",
                    icon: leafletIcon,
                  }
                ).addTo(map);
                marker2
                  .bindPopup(
                    `Date : ${report.date}<br/>Driver: ${report.driver.name}<br/>Location: Current Location<b/>
                        <a class="btn btn-link btn-center" href="/map/report/${report.vehicle}">View</a>`
                  )
                  .openPopup();

                drawLineInMap(positions, colors[color_count]);

                color_count++;
              });
            } else {
              alert("Report Not Founds");
            }
          })
          .catch((error) => {
            console.error(
              "There was a problem with the fetch operation:",
              error
            );
          });
      }

      function generateRandomColor() {
        const letters = "0123456789ABCDEF";
        let color = "#";
        for (let i = 0; i < 6; i++) {
          color += letters[Math.floor(Math.random() * 16)];
        }
        return color;
      }

      function generateUniqueColors(n) {
        // const uniqueColors = new Set();
        //
        // while (uniqueColors.size < n) {
        //     const color = generateRandomColor();
        //     uniqueColors.add(color);
        // }
        //
        // return Array.from(uniqueColors);
        return [
          "#FF5733",
          "#FFC300",
          "#33FF57",
          "#3399FF",
          "#9533FF",
          "#FF33A1",
          "#4CAF50",
          "#FF9800",
          "#2196F3",
          "#E91E63",
        ];
      }

      function viewDayReportInMap(reportId) {
        map.eachLayer((layer) => {
          if (layer.options.name !== "map") map.removeLayer(layer);
        });
        const report = reports.find((report) => report.id == reportId);

        const marker1 = L.marker(
          [report.start_address.lat, report.start_address.lon],
          {
            name: "latest_markers",
            icon: leafletIcon,
          }
        ).addTo(map);
        marker1.bindPopup(`Date : ${report.date}<br/>Driver: ${report.driver.name}<br/>Location: Start Location<br/>
            <a class="btn btn-link btn-center" href="/map/report/${report.vehicle.id}">View</a>`);

        const marker2 = L.marker(
          [report.end_address.lat, report.end_address.lon],
          {
            name: "latest_markers",
            icon: leafletIcon,
          }
        ).addTo(map);
        marker2
          .bindPopup(
            `Date : ${report.date}<br/>Driver: ${report.driver.name}<br/>Location: End Location<br/>
            <a class="btn btn-link btn-center" href="/map/report/${report.vehicle.id}">View</a>`
          )
          .openPopup();

        drawLineInMap(report.positions);

        $("#reportModel").modal("hide");
      }

      function viewReport(reportId) {
        const report = reports.find((report) => report.id == reportId);

        $("#reportModel .modal-content").html(`  <div class="modal-header">
            <h1 class="modal-title fs-5" id="staticBackdropLabel">Date : ${report.date}</h1>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
            <div class="row">
                <div class="col-3 report-item">
                     <div class="row">
                        <div class="col-3">
                            <i class="bi bi-person"></i>
                        </div>
                        <div class="col-9">
                            <div class="row">Driver</div>
                            <div class="row">${report.driver.name}</div>
                        </div>
                    </div>
                </div>
                <div class="col-3 report-item">
                     <div class="row">
                        <div class="col-3">
                            <i class="bi bi-speedometer"></i>
                        </div>
                        <div class="col-9">
                            <div class="row">Average Spped</div>
                            <div class="row">${report.average_speed}</div>
                        </div>
                    </div>
                </div>
                <div class="col-3 report-item">
                     <div class="row">
                        <div class="col-3">
                            <i class="bi bi-speedometer"></i>
                        </div>
                        <div class="col-9">
                            <div class="row">Max Speed</div>
                            <div class="row">${report.max_Speed}</div>
                        </div>
                    </div>
                </div>
                <div class="col-3 report-item">
                     <div class="row">
                        <div class="col-3">
                            <i class="bi bi-sign-turn-right"></i>
                        </div>
                        <div class="col-9">
                            <div class="row">Distance</div>
                            <div class="row">${report.distance}</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row mt-5">
                <div class="col-3 report-item">
                     <div class="row">
                        <div class="col-3">
                            <i class="bi bi-fuel-pump"></i>
                        </div>
                        <div class="col-9">
                            <div class="row">Fuel Spent</div>
                            <div class="row">${report.spent_fuel}</div>
                        </div>
                    </div>
                </div>
                <div class="col-3 report-item">
                     <div class="row">
                        <div class="col-3">
                            <i class="bi bi-clock-history"></i>
                        </div>
                        <div class="col-9">
                            <div class="row">Operation Time</div>
                            <div class="row">${report.duration}</div>
                        </div>
                    </div>
                </div>
                <div class="col-3 report-item">
                     <div class="row">
                        <div class="col-3">
                            <i class="bi bi-clock-fill"></i>
                        </div>
                        <div class="col-9">
                            <div class="row">Start Time</div>
                            <div class="row">${report.start_time}</div>
                        </div>
                    </div>
                </div>
                <div class="col-3 report-item">
                     <div class="row">
                        <div class="col-3">
                            <i class="bi bi-clock-fill"></i>
                        </div>
                        <div class="col-9">
                            <div class="row">End Time</div>
                            <div class="row">${report.end_time}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Close</button>
            <button type="button" class="btn" style="background: #017E84; color: white" onclick="replayVehicleTrip('${report.id}')">Replay</button>
            <button type="button" class="btn" style="background: #714B67; color: white" onclick="viewDayReportInMap('${report.id}')">View in Map</button>
        </div>
        `);
        $("#reportModel").modal("show");
      }

      function replayVehicleTrip(reportId) {
        $("#reportModel").modal("hide");
        // speed_control_box.show()
        map.eachLayer((layer) => {
          if (layer.options.name !== "map") map.removeLayer(layer);
        });
        const report = reports.find((report) => report.id == reportId);
        drawLineInMap(report.positions);

        report.positions.map((position, key) => {
          if (key % 2 === 0)
            L.marker([position.lat, position.lon], {
              icon: dotMapIcon,
            })
              .addTo(map)
              .bindPopup(
                `Speed: ${Number(position.speed.toFixed(2))} Km/h</br>Time : ${
                  position.time
                }</br>`
              );
        });

        const positiona = report.positions[0];

        let marker = L.marker([positiona.lat, positiona.lon], {
          icon: leafletIcon,
        }).addTo(map);

        report.positions.map((position, index) => {
          const course = position.course;
          setTimeout(() => {
            marker.setLatLng([position.lat, position.lon]);
            marker.setIcon(rotateSVG(course));
            // marker.bindPopup(`<br>Driver: ${report.driver.name}<br>Speed: ${Number(position.speed.toFixed(2))} Km/h<br>Time : ${position.time}</br>`).openPopup()
          }, index * (speed * 1000));
        });
      }

      function changeReplaySpeed(action) {
        if (action === "plus") {
          speed += 0.5;
        } else {
          if (speed !== 0) speed -= 0.5;
        }
        $("#speed_display").text(`${speed} Second`);
      }

      function rotateSVG(angle) {
        // Create a temporary div to hold the SVG
        const tempDiv = document.createElement("div");
        tempDiv.innerHTML = truckIcon;

        // Get the SVG element
        const svgElement = tempDiv.querySelector("svg");

        // Rotate the SVG using the transform attribute
        svgElement.setAttribute("transform", `rotate(${angle})`);

        // Convert the modified SVG back to a string
        const svgIcon = tempDiv.innerHTML;

        return new L.Icon({
          iconUrl: "data:image/svg+xml;base64," + btoa(svgIcon),
          iconSize: [80, 80], // Adjust the size as needed
          iconAnchor: [16, 16], // Adjust the anchor point
        });
      }

      function highlightDevice(deviceId) {
        $(".device-box").removeClass("box-hover");
        $(`#device-${deviceId}`).addClass("box-hover");
      }
    </script>
  </body>
</html>
